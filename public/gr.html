<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Validate QR — WishClip</title>
<style>
  body{margin:0;background:#0b0b10;color:#f7f7f9;font-family:system-ui,Inter,Arial}
  .wrap{max-width:720px;margin:0 auto;padding:20px}
  .card{background:#111320;border:1px solid #23263b;border-radius:14px;padding:18px}
  h1{margin:0 0 10px 0;font-size:22px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input{flex:1;min-width:200px;padding:12px;border-radius:10px;border:1px solid #2a2e44;background:#1b1e2d;color:#fff}
  button{padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
  .primary{background:#7f5af0;color:#fff}
  .ghost{background:#1b1e2d;border:1px solid #2a2e44;color:#fff}
  .err{color:#ff8383;margin-top:10px}
  .ok{color:#22c55e;margin-top:10px}
  video{width:100%;border-radius:12px;margin-top:12px;border:1px solid #23263b}
</style>
</head>
<body>
  <div class="wrap">
    <a href="/" class="link" style="color:#a1b6ff;text-decoration:none">&larr; Back</a>
    <div class="card" style="margin-top:12px">
      <h1 id="h1">Enter or scan your QR code</h1>
      <div class="row">
        <input id="code" placeholder="WISH-XXXX-XXXX or OFF-XXXX-XXXX" />
        <button class="primary" id="checkBtn">Continue</button>
        <button class="ghost" id="scanBtn">Scan QR</button>
      </div>
      <div id="msg"></div>
      <video id="video" playsinline></video>
    </div>
  </div>

  <!-- jsQR (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const lang = localStorage.getItem('wishclip_lang')||'en';
    const t = {
      en:{h1:"Enter or scan your QR code", ok:"QR validated. Redirecting…", err:"Invalid or unpaid QR code."},
      ru:{h1:"Введите или отсканируйте ваш QR-код", ok:"QR подтверждён. Переходим…", err:"Неверный или неоплаченный QR-код."}
      // при желании — добавить остальные переводы
    }[lang] || {h1:"Enter or scan your QR code", ok:"QR validated. Redirecting…", err:"Invalid or unpaid QR code."};

    document.getElementById('h1').textContent = t.h1;

    const codeEl = document.getElementById('code');
    const msgEl = document.getElementById('msg');
    const video = document.getElementById('video');

    document.getElementById('checkBtn').addEventListener('click', validate);
    document.getElementById('scanBtn').addEventListener('click', startScan);

    async function validate(){
      const code = (codeEl.value||"").trim();
      if(!code) return;
      msgEl.textContent = "…";
      msgEl.className="";
      try{
        const res = await fetch(`/api/validate-qr?code=${encodeURIComponent(code)}`);
        const data = await res.json();
        if(data.valid){
          msgEl.textContent = t.ok; msgEl.className="ok";
          localStorage.setItem('wishclip_access','qr');
          localStorage.setItem('wishclip_qr',code);
          window.location.href = "/chat.html";
        }else{
          msgEl.textContent = t.err; msgEl.className="err";
        }
      }catch(e){
        msgEl.textContent = t.err; msgEl.className="err";
      }
    }

    // simple camera scan using jsQR
    let stream, rafId;
    async function startScan(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
        video.srcObject = stream;
        await video.play();
        scanLoop();
      }catch(e){
        msgEl.textContent = "Camera permission denied."; msgEl.className="err";
      }
    }
    function scanLoop(){
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h){ rafId = requestAnimationFrame(scanLoop); return; }
      canvas.width = w; canvas.height = h;
      ctx.drawImage(video,0,0,w,h);
      const imgData = ctx.getImageData(0,0,w,h);
      const code = jsQR(imgData.data, w, h);
      if(code && code.data){
        codeEl.value = code.data.trim();
        stopScan();
        validate();
      }else{
        rafId = requestAnimationFrame(scanLoop);
      }
    }
    function stopScan(){
      if(rafId) cancelAnimationFrame(rafId);
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    }
    window.addEventListener('beforeunload', stopScan);
  </script>
</body>
</html>
